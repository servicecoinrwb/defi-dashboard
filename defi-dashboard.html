<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi & Credit Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #1f2937; /* dark:bg-gray-800 */
            border: 1px solid #374151; /* dark:border-gray-700 */
        }
        .progress-bar-bg {
             background-color: #374151; /* dark:bg-gray-700 */
        }
        /* Custom scrollbar for transaction log */
        #transaction-log::-webkit-scrollbar {
            width: 8px;
        }
        #transaction-log::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        #transaction-log::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        #transaction-log::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">DeFi & Credit Dashboard</h1>
                <p class="text-gray-400 mt-1">Track your credit utilization and DeFi loan health in real-time.</p>
            </div>
            <button id="settings-button" class="p-2 rounded-lg hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0-2.4l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </header>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <!-- Card 1: Credit Card Status -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-blue-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">Credit Card</h2>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span>Balance:</span> <span id="cc-balance" class="font-medium text-white">$0.00</span></div>
                    <div class="flex justify-between"><span>Available:</span> <span id="cc-available" class="font-medium text-green-400">$5,000.00</span></div>
                    <div class="flex justify-between"><span>Limit:</span> <span id="cc-limit" class="font-medium text-gray-400">$5,000.00</span></div>
                </div>
                <div class="mt-4">
                    <div class="progress-bar-bg w-full rounded-full h-2.5">
                        <div id="cc-progress" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Card 2: DeFi Loan Status -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-purple-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">DeFi Loan</h2>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span>Collateral Value:</span> <span id="collateral-value" class="font-medium text-white">$0.00</span></div>
                    <div class="flex justify-between"><span>Loan Balance:</span> <span id="defi-balance" class="font-medium text-white">$0.00</span></div>
                    <div class="flex justify-between"><span>Available to Borrow:</span> <span id="defi-available" class="font-medium text-green-400">$5,000.00</span></div>
                </div>
                <div class="mt-4">
                    <p class="text-sm font-medium text-white mb-1">Loan-to-Value (LTV): <span id="ltv-percentage">0.00%</span></p>
                    <div class="progress-bar-bg w-full rounded-full h-2.5 relative">
                        <div id="ltv-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                        <div id="liquidation-marker" class="absolute top-0 h-full w-0.5 bg-red-500" style="left: 80%;" title="Liquidation Threshold"></div>
                    </div>
                     <p class="text-xs text-gray-400 mt-1">Liquidation at <span id="liquidation-threshold-text">80</span>%</p>
                </div>
            </div>

            <!-- Card 3: Actions -->
            <div class="card rounded-xl shadow-lg p-6 md:col-span-2 lg:col-span-1">
                 <div class="flex items-center mb-4">
                     <div class="p-2 bg-green-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/><path d="M12 8v8"/><path d="m8.5 12.5 7-5"/><path d="m8.5 16.5 7-5"/></svg>
                     </div>
                    <h2 class="text-xl font-semibold text-white">Actions</h2>
                </div>
                <!-- Add Purchase Form -->
                <form id="add-purchase-form" class="space-y-4">
                    <div>
                        <label for="purchase-amount" class="block text-sm font-medium text-gray-300">New Card Purchase</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-600 bg-gray-700 text-gray-400 sm:text-sm">$</span>
                            <input type="number" id="purchase-amount" class="flex-1 block w-full rounded-none rounded-r-md bg-gray-800 border-gray-600 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="150.75" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500">Add Purchase</button>
                </form>
                <!-- Pay with DeFi Button -->
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <button id="pay-with-defi" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">Pay Card with DeFi Loan</button>
                    <p class="text-xs text-center text-gray-400 mt-2">Moves credit card balance to DeFi loan</p>
                </div>
            </div>
            
            <!-- Card 4: Transaction Log -->
            <div class="card rounded-xl shadow-lg p-6 md:col-span-2 lg:col-span-3">
                <h2 class="text-xl font-semibold text-white mb-4">Transaction Log</h2>
                <div id="transaction-log" class="h-64 overflow-y-auto space-y-3 pr-2">
                    <!-- Transactions will be dynamically inserted here -->
                     <p class="text-gray-500 text-center pt-8">No transactions yet.</p>
                </div>
            </div>

        </div>

    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="card w-full max-w-md p-6 rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Settings</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="settings-form" class="space-y-4">
                <div>
                    <label for="setting-cc-limit" class="block text-sm font-medium text-gray-300">Credit Card Limit ($)</label>
                    <input type="number" id="setting-cc-limit" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="5000">
                </div>
                 <div>
                    <label for="setting-defi-limit" class="block text-sm font-medium text-gray-300">DeFi Loan Position Limit ($)</label>
                    <input type="number" id="setting-defi-limit" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="5000">
                </div>
                <div>
                    <label for="setting-collateral-amount" class="block text-sm font-medium text-gray-300">Crypto Collateral Amount</label>
                    <input type="number" id="setting-collateral-amount" step="any" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="1.5">
                </div>
                <div>
                    <label for="setting-collateral-ticker" class="block text-sm font-medium text-gray-300">Collateral Ticker (e.g., bitcoin, ethereum)</label>
                    <input type="text" id="setting-collateral-ticker" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="ethereum">
                </div>
                <div>
                    <label for="setting-liquidation-threshold" class="block text-sm font-medium text-gray-300">Liquidation Threshold (%)</label>
                    <input type="number" id="setting-liquidation-threshold" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="80">
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-settings" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors text-white font-semibold">Save</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT REFERENCES ---
            const DOMElements = {
                ccBalance: document.getElementById('cc-balance'),
                ccAvailable: document.getElementById('cc-available'),
                ccLimit: document.getElementById('cc-limit'),
                ccProgress: document.getElementById('cc-progress'),
                defiBalance: document.getElementById('defi-balance'),
                defiAvailable: document.getElementById('defi-available'),
                collateralValue: document.getElementById('collateral-value'),
                ltvPercentage: document.getElementById('ltv-percentage'),
                ltvBar: document.getElementById('ltv-bar'),
                liquidationMarker: document.getElementById('liquidation-marker'),
                liquidationThresholdText: document.getElementById('liquidation-threshold-text'),
                addPurchaseForm: document.getElementById('add-purchase-form'),
                purchaseAmountInput: document.getElementById('purchase-amount'),
                payWithDeFiButton: document.getElementById('pay-with-defi'),
                transactionLog: document.getElementById('transaction-log'),
                settingsButton: document.getElementById('settings-button'),
                settingsModal: document.getElementById('settings-modal'),
                closeModalButton: document.getElementById('close-modal-button'),
                cancelSettingsButton: document.getElementById('cancel-settings'),
                settingsForm: document.getElementById('settings-form'),
            };

            // --- APPLICATION STATE ---
            let state = {
                ccLimit: 5000,
                ccBalance: 0,
                defiLoanPositionLimit: 5000,
                defiLoanBalance: 0,
                collateralAmount: 1.5,
                collateralTicker: 'ethereum',
                collateralPrice: 0, // Fetched from API
                liquidationThreshold: 80,
                transactions: [],
            };

            // --- UTILITY FUNCTIONS ---
            const formatCurrency = (amount) => `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const loadState = () => {
                const savedState = localStorage.getItem('defiCreditDashboardState');
                if (savedState) {
                    state = JSON.parse(savedState);
                }
            };
            
            const saveState = () => {
                localStorage.setItem('defiCreditDashboardState', JSON.stringify(state));
            };

            // --- UI UPDATE FUNCTION ---
            const updateUI = () => {
                // Derived values
                const ccAvailable = state.ccLimit - state.ccBalance;
                const ccUsagePercent = (state.ccBalance / state.ccLimit) * 100;
                const collateralValue = state.collateralAmount * state.collateralPrice;
                const defiAvailableToBorrow = Math.max(0, state.defiLoanPositionLimit - state.defiLoanBalance);
                const ltv = collateralValue > 0 ? (state.defiLoanBalance / collateralValue) * 100 : 0;

                // Update Credit Card panel
                DOMElements.ccLimit.textContent = formatCurrency(state.ccLimit);
                DOMElements.ccBalance.textContent = formatCurrency(state.ccBalance);
                DOMElements.ccAvailable.textContent = formatCurrency(ccAvailable);
                DOMElements.ccProgress.style.width = `${ccUsagePercent}%`;

                // Update DeFi Loan panel
                DOMElements.collateralValue.textContent = formatCurrency(collateralValue);
                DOMElements.defiBalance.textContent = formatCurrency(state.defiLoanBalance);
                DOMElements.defiAvailable.textContent = formatCurrency(defiAvailableToBorrow);
                
                // Update LTV display
                DOMElements.ltvPercentage.textContent = `${ltv.toFixed(2)}%`;
                DOMElements.ltvBar.style.width = `${ltv}%`;
                
                // Update LTV bar color based on risk
                const dangerZone = state.liquidationThreshold - 15;
                const warningZone = state.liquidationThreshold - 30;
                if (ltv >= dangerZone) {
                    DOMElements.ltvBar.className = 'bg-red-500 h-2.5 rounded-full';
                } else if (ltv >= warningZone) {
                    DOMElements.ltvBar.className = 'bg-yellow-500 h-2.5 rounded-full';
                } else {
                    DOMElements.ltvBar.className = 'bg-green-500 h-2.5 rounded-full';
                }
                
                // Update liquidation marker position
                DOMElements.liquidationThresholdText.textContent = state.liquidationThreshold;
                DOMElements.liquidationMarker.style.left = `${state.liquidationThreshold}%`;


                // Update Pay with DeFi button state
                DOMElements.payWithDeFiButton.disabled = state.ccBalance <= 0;

                // Update Transaction Log
                renderTransactions();
                
                saveState();
            };
            
            // --- TRANSACTION LOG RENDERER ---
            const renderTransactions = () => {
                if(state.transactions.length === 0) {
                     DOMElements.transactionLog.innerHTML = `<p class="text-gray-500 text-center pt-8">No transactions yet.</p>`;
                     return;
                }
                
                DOMElements.transactionLog.innerHTML = state.transactions
                    .map(tx => `
                        <div class="flex justify-between items-center text-sm p-2 rounded-md ${tx.type === 'purchase' ? 'bg-gray-800' : 'bg-purple-900/50'}">
                           <div>
                                <p class="font-medium text-white">${tx.description}</p>
                                <p class="text-xs text-gray-400">${new Date(tx.date).toLocaleString()}</p>
                           </div>
                           <span class="font-bold ${tx.amount > 0 ? 'text-red-400' : 'text-green-400'}">
                                ${tx.type === 'payment' ? '+' : ''}${formatCurrency(tx.amount)}
                           </span>
                        </div>
                    `).join('');
            };
            
            const addTransaction = (type, description, amount) => {
                 state.transactions.unshift({
                     id: Date.now(),
                     date: new Date().toISOString(),
                     type,
                     description,
                     amount
                 });
                 if (state.transactions.length > 50) { // Keep log from getting too long
                     state.transactions.pop();
                 }
            };

            // --- API CALL ---
            const fetchCryptoPrice = async () => {
                if (!state.collateralTicker) return;
                try {
                    const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${state.collateralTicker}&vs_currencies=usd`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    if (data[state.collateralTicker] && data[state.collateralTicker].usd) {
                        state.collateralPrice = data[state.collateralTicker].usd;
                    }
                } catch (error) {
                    console.error('Failed to fetch crypto price:', error);
                    // You might want to show an error to the user here
                } finally {
                    updateUI(); // Update UI even if fetch fails to show other state changes
                }
            };

            // --- EVENT HANDLERS ---
            DOMElements.addPurchaseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(DOMElements.purchaseAmountInput.value);
                if (isNaN(amount) || amount <= 0) return;

                if (state.ccBalance + amount > state.ccLimit) {
                    alert('This purchase exceeds your credit limit.');
                    return;
                }

                state.ccBalance += amount;
                addTransaction('purchase', `Credit Card Purchase`, amount);
                DOMElements.purchaseAmountInput.value = '';
                updateUI();
            });

            DOMElements.payWithDeFiButton.addEventListener('click', () => {
                const amountToPay = state.ccBalance;
                if (amountToPay <= 0) return;
                
                if (state.defiLoanBalance + amountToPay > state.defiLoanPositionLimit) {
                    alert('This payment exceeds your DeFi loan position limit.');
                    return;
                }

                state.defiLoanBalance += amountToPay;
                state.ccBalance = 0;
                addTransaction('payment', `Payoff from DeFi`, amountToPay);
                updateUI();
            });
            
            // --- MODAL HANDLING ---
            const openModal = () => {
                // Populate modal with current state
                document.getElementById('setting-cc-limit').value = state.ccLimit;
                document.getElementById('setting-defi-limit').value = state.defiLoanPositionLimit;
                document.getElementById('setting-collateral-amount').value = state.collateralAmount;
                document.getElementById('setting-collateral-ticker').value = state.collateralTicker;
                document.getElementById('setting-liquidation-threshold').value = state.liquidationThreshold;
                DOMElements.settingsModal.classList.remove('hidden');
            };
            
            const closeModal = () => DOMElements.settingsModal.classList.add('hidden');
            
            DOMElements.settingsButton.addEventListener('click', openModal);
            DOMElements.closeModalButton.addEventListener('click', closeModal);
            DOMElements.cancelSettingsButton.addEventListener('click', closeModal);
            
            DOMElements.settingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                state.ccLimit = parseFloat(document.getElementById('setting-cc-limit').value);
                state.defiLoanPositionLimit = parseFloat(document.getElementById('setting-defi-limit').value);
                state.collateralAmount = parseFloat(document.getElementById('setting-collateral-amount').value);
                state.collateralTicker = document.getElementById('setting-collateral-ticker').value.toLowerCase().trim();
                state.liquidationThreshold = parseFloat(document.getElementById('setting-liquidation-threshold').value);
                
                closeModal();
                fetchCryptoPrice(); // Re-fetch price with new ticker and update UI
            });

            // --- INITIALIZATION ---
            loadState();
            fetchCryptoPrice();
            setInterval(fetchCryptoPrice, 60000); // Refresh crypto price every 60 seconds
        });
    </script>
</body>
</html>
