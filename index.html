<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi & Credit Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #1f2937; /* dark:bg-gray-800 */
            border: 1px solid #374151; /* dark:border-gray-700 */
        }
        .progress-bar-bg {
             background-color: #374151; /* dark:bg-gray-700 */
        }
        #transaction-log::-webkit-scrollbar {
            width: 8px;
        }
        #transaction-log::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        #transaction-log::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        #transaction-log::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .remove-collateral-btn, .delete-tx-btn {
            font-size: 1.5rem;
            line-height: 1;
            padding: 0 0.5rem;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">DeFi & Credit Dashboard</h1>
                <p class="text-gray-400 mt-1">Track your credit utilization and DeFi loan health in real-time.</p>
            </div>
            <button id="settings-button" class="p-2 rounded-lg hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0-2.4l.15-.08a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </header>

        <!-- Overall Summary Card -->
        <div class="card rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center mb-4">
                <div class="p-2 bg-gray-500/20 rounded-lg mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                </div>
                <h2 class="text-xl font-semibold text-white">Overall Financial Summary</h2>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                <div>
                    <p class="text-sm text-gray-400">Total Collateral</p>
                    <p id="summary-total-collateral" class="text-lg font-bold text-white">$0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Total Loan Principal</p>
                    <p id="summary-total-principal" class="text-lg font-bold text-red-400">$0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Total Interest</p>
                    <p id="summary-total-interest" class="text-lg font-bold text-red-500">$0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Total Owed</p>
                    <p id="summary-total-owed" class="text-lg font-bold text-red-400">$0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Total Rewards Value</p>
                    <p id="summary-total-rewards" class="text-lg font-bold text-green-400">$0.00</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            <!-- Static Cards -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-blue-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">Credit Card</h2>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span>Balance:</span> <span id="cc-balance" class="font-medium text-white">$0.00</span></div>
                    <div class="flex justify-between"><span>Available:</span> <span id="cc-available" class="font-medium text-green-400">$5,000.00</span></div>
                    <div class="flex justify-between"><span>Limit:</span> <span id="cc-limit" class="font-medium text-gray-400">$5,000.00</span></div>
                </div>
                <div class="mt-4">
                    <div class="progress-bar-bg w-full rounded-full h-2.5">
                        <div id="cc-progress" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                     <div class="p-2 bg-teal-500/20 rounded-lg mr-4">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-400"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                       </div>
                    <h2 class="text-xl font-semibold text-white">Grail Rewards</h2>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span>USDC.e Balance:</span> <span id="rewards-balance" class="font-medium text-white">$0.00</span></div>
                    <div class="flex justify-between"><span>Total Earned:</span> <span id="total-rewards-earned" class="font-medium text-gray-400">$0.00</span></div>
                </div>
                <form id="claim-rewards-form" class="mt-4 pt-4 border-t border-gray-700 space-y-4">
                    <div>
                        <label for="rewards-amount" class="block text-sm font-medium text-gray-300">Claim New Rewards</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-600 bg-gray-700 text-gray-400 sm:text-sm">$</span>
                            <input type="number" id="rewards-amount" class="flex-1 block w-full rounded-none rounded-r-md bg-gray-800 border-gray-600 focus:ring-teal-500 focus:border-teal-500 sm:text-sm" placeholder="50.25" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Claim Rewards</button>
                </form>
            </div>
            
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-yellow-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="text-yellow-400" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 10h3a2 2 0 1 1 0 4h-3h4a2 2 0 1 0 0 -4h-4" /><path d="M12 7v2" /><path d="M12 15v2" /></svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">Bitcoin Rewards</h2>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span>BTC Balance:</span> <span id="btc-rewards-balance" class="font-medium text-white">0.00000000 BTC</span></div>
                    <div class="flex justify-between"><span>Cash Back Rate:</span> <span id="btc-rewards-rate" class="font-medium text-white">2%</span></div>
                </div>
            </div>

            <div class="card rounded-xl shadow-lg p-6">
                 <div class="flex items-center mb-4">
                       <div class="p-2 bg-green-500/20 rounded-lg mr-4">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/><path d="M12 8v8"/><path d="m8.5 12.5 7-5"/><path d="m8.5 16.5 7-5"/></svg>
                       </div>
                    <h2 class="text-xl font-semibold text-white">Actions</h2>
                </div>
                <div class="space-y-4">
                    <form id="add-purchase-form" class="space-y-4">
                        <div>
                            <label for="purchase-amount" class="block text-sm font-medium text-gray-300">New Card Purchase</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-600 bg-gray-700 text-gray-400 sm:text-sm">$</span>
                                <input type="number" id="purchase-amount" class="flex-1 block w-full rounded-none rounded-r-md bg-gray-800 border-gray-600 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="150.75" step="0.01" required>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Add Purchase</button>
                    </form>
                    <div class="pt-4 border-t border-gray-700 space-y-2">
                        <label for="action-loan-select" class="block text-sm font-medium text-gray-300">Pay Card from Loan</label>
                        <select id="action-loan-select" class="w-full bg-gray-800 border-gray-600 rounded-md shadow-sm text-sm"></select>
                        <button id="pay-with-defi" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed mt-2">Pay Card</button>
                    </div>
                     <div class="pt-4 border-t border-gray-700">
                         <button id="advance-day-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Advance to Next Day</button>
                    </div>
                </div>
            </div>

            <!-- Dynamic Loan Cards Container -->
            <div id="loan-cards-container" class="contents"></div>
            
            <!-- Performance Chart Card -->
            <div class="card rounded-xl shadow-lg p-6 lg:col-span-4">
                 <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-500/20 rounded-lg mr-4">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg>
                        </div>
                        <h2 class="text-xl font-semibold text-white">Portfolio Performance</h2>
                    </div>
                    <div id="equity-trend-indicator" class="text-right"></div>
                 </div>
                 <div>
                     <canvas id="performance-chart"></canvas>
                 </div>
            </div>

            <!-- Loan Actions Card -->
            <div class="card rounded-xl shadow-lg p-6 lg:col-span-2">
                 <div class="flex items-center mb-4">
                     <h2 class="text-xl font-semibold text-white">Loan Management</h2>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <form id="repay-loan-form" class="space-y-4">
                            <h3 class="text-md font-semibold text-white -mb-2">Repay Loan</h3>
                            <div>
                                <label for="repay-loan-select" class="block text-sm font-medium text-gray-300">Target Loan</label>
                                <select id="repay-loan-select" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="repay-amount" class="block text-sm font-medium text-gray-300">Repay Amount</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-600 bg-gray-700 text-gray-400 sm:text-sm">$</span>
                                    <input type="number" id="repay-amount" class="flex-1 block w-full rounded-none rounded-r-md bg-gray-800 border-gray-600 focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="1000.00" step="0.01" required>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Repay from Source</button>
                             <button id="repay-with-rewards-btn" type="button" class="w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Repay with Grail Rewards</button>
                        </form>
                    </div>
                    <div>
                        <form id="inter-loan-repay-form" class="space-y-4">
                            <h3 class="text-md font-semibold text-white -mb-2">Inter-Loan Payment</h3>
                             <div>
                                <label for="repay-source-loan" class="block text-sm font-medium text-gray-300">Borrow From</label>
                                <select id="repay-source-loan" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm"></select>
                            </div>
                             <div>
                                <label for="repay-target-loan" class="block text-sm font-medium text-gray-300">Repay To</label>
                                <select id="repay-target-loan" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="inter-loan-repay-amount" class="block text-sm font-medium text-gray-300">Amount</label>
                                 <div class="mt-1 flex rounded-md shadow-sm">
                                    <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-600 bg-gray-700 text-gray-400 sm:text-sm">$</span>
                                    <input type="number" id="inter-loan-repay-amount" class="flex-1 block w-full rounded-none rounded-r-md bg-gray-800 border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="5000.00" step="0.01" required>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Execute Transfer</button>
                        </form>
                    </div>
                 </div>
            </div>

            <!-- Card: Collateral Management -->
            <div class="card rounded-xl shadow-lg p-6 lg:col-span-2">
                <form id="add-collateral-form" class="space-y-4">
                    <h3 class="text-xl font-semibold text-white">Manage Collateral</h3>
                    <div>
                        <label for="collateral-loan-select" class="block text-sm font-medium text-gray-300">Add to Loan</label>
                        <select id="collateral-loan-select" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm"></select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="collateral-name-input" class="block text-sm font-medium text-gray-300">Asset Name</label>
                            <input type="text" id="collateral-name-input" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" placeholder="e.g., Plume" required>
                        </div>
                         <div>
                            <label for="collateral-amount-input" class="block text-sm font-medium text-gray-300">Amount</label>
                            <input type="number" id="collateral-amount-input" step="any" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" placeholder="e.g., 119000" required>
                        </div>
                        <div>
                            <label for="collateral-ticker-input" class="block text-sm font-medium text-gray-300">CoinGecko ID</label>
                            <input type="text" id="collateral-ticker-input" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" placeholder="e.g., ethereum" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">Add / Update Collateral</button>
                </form>
            </div>

            <!-- Card: Transaction Log -->
            <div class="card rounded-xl shadow-lg p-6 lg:col-span-4">
                <h2 class="text-xl font-semibold text-white mb-4">Transaction Log</h2>
                <div id="transaction-log" class="h-64 overflow-y-auto space-y-3 pr-2">
                     <p class="text-gray-500 text-center pt-8">No transactions yet.</p>
                </div>
            </div>

        </div>

    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="card w-full max-w-md p-6 rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">General Settings</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="settings-form" class="space-y-4">
                 <div>
                    <label for="setting-cc-limit" class="block text-sm font-medium text-gray-300">Credit Card Limit ($)</label>
                    <input type="number" id="setting-cc-limit" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" step="any" required>
                </div>
                <div>
                    <label for="setting-btc-rewards" class="block text-sm font-medium text-gray-300">Bitcoin Rewards Rate (%)</label>
                    <input type="number" id="setting-btc-rewards" step="any" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" required>
                </div>
                <div class="pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-semibold text-white">Loan Settings</h3>
                    <div class="space-y-2 mt-2" id="loan-settings-container">
                        <!-- Loan settings will be dynamically inserted here -->
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-settings" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors text-white font-semibold">Save</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT REFERENCES ---
            const DOMElements = {
                ccBalance: document.getElementById('cc-balance'),
                ccAvailable: document.getElementById('cc-available'),
                ccLimit: document.getElementById('cc-limit'),
                ccProgress: document.getElementById('cc-progress'),
                addPurchaseForm: document.getElementById('add-purchase-form'),
                purchaseAmountInput: document.getElementById('purchase-amount'),
                payWithDeFiButton: document.getElementById('pay-with-defi'),
                advanceDayButton: document.getElementById('advance-day-btn'),
                actionLoanSelect: document.getElementById('action-loan-select'),
                transactionLog: document.getElementById('transaction-log'),
                settingsButton: document.getElementById('settings-button'),
                settingsModal: document.getElementById('settings-modal'),
                closeModalButton: document.getElementById('close-modal-button'),
                cancelSettingsButton: document.getElementById('cancel-settings'),
                settingsForm: document.getElementById('settings-form'),
                loanSettingsContainer: document.getElementById('loan-settings-container'),
                rewardsBalance: document.getElementById('rewards-balance'),
                totalRewardsEarned: document.getElementById('total-rewards-earned'),
                claimRewardsForm: document.getElementById('claim-rewards-form'),
                rewardsAmountInput: document.getElementById('rewards-amount'),
                repayLoanForm: document.getElementById('repay-loan-form'),
                repayAmountInput: document.getElementById('repay-amount'),
                repayLoanSelect: document.getElementById('repay-loan-select'),
                repayWithRewardsBtn: document.getElementById('repay-with-rewards-btn'),
                interLoanRepayForm: document.getElementById('inter-loan-repay-form'),
                repaySourceLoanSelect: document.getElementById('repay-source-loan'),
                repayTargetLoanSelect: document.getElementById('repay-target-loan'),
                interLoanRepayAmountInput: document.getElementById('inter-loan-repay-amount'),
                addCollateralForm: document.getElementById('add-collateral-form'),
                collateralNameInput: document.getElementById('collateral-name-input'),
                collateralAmountInput: document.getElementById('collateral-amount-input'),
                collateralTickerInput: document.getElementById('collateral-ticker-input'),
                collateralLoanSelect: document.getElementById('collateral-loan-select'),
                btcRewardsBalance: document.getElementById('btc-rewards-balance'),
                btcRewardsRate: document.getElementById('btc-rewards-rate'),
                loanCardsContainer: document.getElementById('loan-cards-container'),
                summaryTotalCollateral: document.getElementById('summary-total-collateral'),
                summaryTotalPrincipal: document.getElementById('summary-total-principal'),
                summaryTotalInterest: document.getElementById('summary-total-interest'),
                summaryTotalOwed: document.getElementById('summary-total-owed'),
                summaryTotalRewards: document.getElementById('summary-total-rewards'),
                performanceChartCanvas: document.getElementById('performance-chart'),
                equityTrendIndicator: document.getElementById('equity-trend-indicator'),
            };

            // --- APPLICATION STATE ---
            let state = {
                ccLimit: 5000,
                ccBalance: 0,
                loans: [
                    {
                        id: 1, name: "Camelot Loan", principal: 14402.26, interestAccrued: 0, positionLimit: 18290.82, borrowAPR: 15.7, liquidationThreshold: 80,
                        collaterals: [{ id: 1, assetName: 'GRAIL', amount: 130.009, ticker: 'camelot-token', price: 0 }],
                    },
                    {
                        id: 2, name: "Plume Loan", principal: 0, interestAccrued: 0, positionLimit: 10000, borrowAPR: 10.5, liquidationThreshold: 75,
                        collaterals: [{ id: 2, assetName: 'Plume', amount: 119000, ticker: 'ethereum', price: 0 }],
                    }
                ],
                transactions: [],
                rewardsBalance: 0,
                totalGrailRewardsEarned: 0,
                rewardsBitcoinBalance: 0,
                rewardsBitcoinPercentage: 2,
                bitcoinPrice: 0,
                dailySnapshots: [],
            };

            let performanceChart = null;

            // --- UTILITY FUNCTIONS ---
            const formatCurrency = (amount) => `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const formatNumber = (num) => num.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            const formatBTC = (amount) => `${amount.toFixed(8)} BTC`;

            const loadState = () => {
                const savedState = localStorage.getItem('defiCreditDashboardState');
                if (savedState) {
                    let loaded = JSON.parse(savedState);
                     if (typeof loaded.totalGrailRewardsEarned === 'undefined') {
                        loaded.totalGrailRewardsEarned = loaded.transactions ? loaded.transactions.filter(tx => tx.type === 'reward').reduce((sum, tx) => sum + tx.amount, 0) : 0;
                    }
                    state = { ...state, ...loaded, dailySnapshots: loaded.dailySnapshots || [] };
                }
            };
            
            const saveState = () => {
                localStorage.setItem('defiCreditDashboardState', JSON.stringify(state));
            };

            // --- RENDER FUNCTIONS ---
            const updateLoanSelects = () => {
                const options = state.loans.map(loan => `<option value="${loan.id}">${loan.name}</option>`).join('');
                DOMElements.actionLoanSelect.innerHTML = options;
                DOMElements.repayLoanSelect.innerHTML = options;
                DOMElements.repaySourceLoanSelect.innerHTML = options;
                DOMElements.repayTargetLoanSelect.innerHTML = options;
                DOMElements.collateralLoanSelect.innerHTML = options;
            };
            
            const updateUI = () => {
                // Credit Card
                const ccAvailable = state.ccLimit - state.ccBalance;
                const ccUsagePercent = (state.ccLimit > 0 ? state.ccBalance / state.ccLimit : 0) * 100;
                DOMElements.ccLimit.textContent = formatCurrency(state.ccLimit);
                DOMElements.ccBalance.textContent = formatCurrency(state.ccBalance);
                DOMElements.ccAvailable.textContent = formatCurrency(ccAvailable);
                DOMElements.ccProgress.style.width = `${ccUsagePercent}%`;
                
                // Rewards
                DOMElements.rewardsBalance.textContent = formatCurrency(state.rewardsBalance);
                DOMElements.totalRewardsEarned.textContent = formatCurrency(state.totalGrailRewardsEarned);
                DOMElements.btcRewardsBalance.textContent = formatBTC(state.rewardsBitcoinBalance);
                DOMElements.btcRewardsRate.textContent = `${state.rewardsBitcoinPercentage}%`;
                
                // Summary Calculations
                const summary = state.loans.reduce((acc, loan) => {
                    const totalCollateralValue = loan.collaterals.reduce((total, c) => total + (c.amount * c.price), 0);
                    acc.totalCollateral += totalCollateralValue;
                    acc.totalPrincipal += loan.principal;
                    acc.totalInterest += loan.interestAccrued;
                    return acc;
                }, { totalCollateral: 0, totalPrincipal: 0, totalInterest: 0 });

                const summaryTotalOwed = summary.totalPrincipal + summary.totalInterest;
                const totalBtcValue = state.rewardsBitcoinBalance * state.bitcoinPrice;
                const totalRewardsValue = state.rewardsBalance + totalBtcValue;

                // Update Summary Card
                DOMElements.summaryTotalCollateral.textContent = formatCurrency(summary.totalCollateral);
                DOMElements.summaryTotalPrincipal.textContent = formatCurrency(summary.totalPrincipal);
                DOMElements.summaryTotalInterest.textContent = formatCurrency(summary.totalInterest);
                DOMElements.summaryTotalOwed.textContent = formatCurrency(summaryTotalOwed);
                DOMElements.summaryTotalRewards.textContent = formatCurrency(totalRewardsValue);

                // Loan Cards
                DOMElements.loanCardsContainer.innerHTML = '';
                state.loans.forEach(loan => {
                    const loanCard = createLoanCard(loan);
                    DOMElements.loanCardsContainer.appendChild(loanCard);
                });

                DOMElements.payWithDeFiButton.disabled = state.ccBalance <= 0;
                
                renderPerformanceChart();
                updateLoanSelects();
                renderTransactions();
                saveState();
            };

            const createLoanCard = (loan) => {
                const totalCollateralValue = loan.collaterals.reduce((total, c) => total + (c.amount * c.price), 0);
                const totalOwed = loan.principal + loan.interestAccrued;
                const availableToBorrow = Math.max(0, loan.positionLimit - totalOwed);
                const ltv = totalCollateralValue > 0 ? (totalOwed / totalCollateralValue) * 100 : 0;
                const dangerZone = loan.liquidationThreshold - 15;
                const warningZone = loan.liquidationThreshold - 30;
                let ltvBarClass = 'bg-green-500';
                if (ltv >= dangerZone) ltvBarClass = 'bg-red-500';
                else if (ltv >= warningZone) ltvBarClass = 'bg-yellow-500';

                const card = document.createElement('div');
                card.className = 'card rounded-xl shadow-lg p-6';
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="p-2 bg-purple-500/20 rounded-lg mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </div>
                        <h2 class="text-xl font-semibold text-white">${loan.name}</h2>
                    </div>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between"><span>Collateral Value:</span><span class="font-medium text-white">${formatCurrency(totalCollateralValue)}</span></div>
                        <div class="flex justify-between"><span>Principal:</span><span class="font-medium text-white">${formatCurrency(loan.principal)}</span></div>
                        <div class="flex justify-between"><span>Interest:</span><span class="font-medium text-red-400">${formatCurrency(loan.interestAccrued)}</span></div>
                        <div class="flex justify-between"><span>Total Owed:</span><span class="font-medium text-white">${formatCurrency(totalOwed)}</span></div>
                        <div class="flex justify-between"><span>Available:</span><span class="font-medium text-green-400">${formatCurrency(availableToBorrow)}</span></div>
                        <div class="flex justify-between"><span>APR:</span><span class="font-medium text-white">${loan.borrowAPR}%</span></div>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm font-medium text-white mb-1">LTV: ${ltv.toFixed(2)}%</p>
                        <div class="progress-bar-bg w-full rounded-full h-2.5 relative">
                            <div class="${ltvBarClass} h-2.5 rounded-full transition-all" style="width: ${ltv}%"></div>
                            <div class="absolute top-0 h-full w-0.5 bg-red-500" style="left: ${loan.liquidationThreshold}%;" title="Liquidation"></div>
                        </div>
                    </div>
                    <div id="collateral-list-${loan.id}" class="mt-4 space-y-2 max-h-24 overflow-y-auto pr-2">
                        ${loan.collaterals.map(c => `
                            <div class="flex justify-between items-center text-xs p-1.5 rounded-md bg-gray-700/50">
                                <div>
                                    <p class="font-bold text-white">${c.assetName} (${formatNumber(c.amount)})</p>
                                    <p class="text-gray-400">Value: ${formatCurrency(c.amount * c.price)}</p>
                                </div>
                                <button data-loan-id="${loan.id}" data-collateral-id="${c.id}" class="remove-collateral-btn text-red-400 hover:text-red-300 transition-colors">&times;</button>
                            </div>
                        `).join('') || '<p class="text-xs text-gray-500 text-center">No collateral</p>'}
                    </div>
                `;
                return card;
            };

            const renderTransactions = () => {
                 if(state.transactions.length === 0) {
                     DOMElements.transactionLog.innerHTML = `<p class="text-gray-500 text-center pt-8">No transactions yet.</p>`;
                     return;
                }
                DOMElements.transactionLog.innerHTML = state.transactions.map(tx => {
                    const getTxBgColor = (type) => ({'purchase':'bg-gray-800','payment':'bg-purple-900/50','reward':'bg-teal-900/50','reward_btc':'bg-yellow-900/50','repayment':'bg-green-900/50','collateral_add':'bg-orange-900/50','collateral_remove':'bg-red-900/50','interest':'bg-red-900/50','loan_transfer':'bg-indigo-900/50'}[type] || 'bg-gray-800');
                    const getTxAmountColor = (type) => (['purchase','collateral_remove','interest'].includes(type) ? 'text-red-400' : 'text-green-400');
                    const isBtcTx = tx.type === 'reward_btc';
                    let formattedAmount = isBtcTx ? `+${formatBTC(tx.amount)}` : (getTxAmountColor(tx.type) === 'text-red-400' ? `-${formatCurrency(tx.amount)}` : `+${formatCurrency(tx.amount)}`);
                    if(tx.type === 'loan_transfer') formattedAmount = formatCurrency(tx.amount);
                    return `
                    <div class="flex justify-between items-center text-sm p-2 rounded-md ${getTxBgColor(tx.type)}">
                       <div class="flex items-center">
                           <button data-id="${tx.id}" class="delete-tx-btn text-gray-500 hover:text-red-400 mr-3 text-xl leading-none" title="Delete Transaction">&times;</button>
                           <div>
                                <p class="font-medium text-white">${tx.description}</p>
                                <p class="text-xs text-gray-400">${new Date(tx.date).toLocaleString()}</p>
                           </div>
                       </div>
                       <span class="font-bold ${getTxAmountColor(tx.type)}">${formattedAmount}</span>
                    </div>`;
                }).join('');
            };
            
             const renderPerformanceChart = () => {
                const ctx = DOMElements.performanceChartCanvas.getContext('2d');
                const snapshots = state.dailySnapshots;
                
                let trendHtml = '<p class="text-sm text-gray-400">No trend data yet.</p>';

                if (snapshots.length >= 2) {
                    const last = snapshots[snapshots.length - 1].netEquity;
                    const secondLast = snapshots[snapshots.length - 2].netEquity;
                    const change = last - secondLast;
                    if (change > 0) {
                        trendHtml = `<p class="text-sm text-green-400">Equity is Up <span class="font-bold">${formatCurrency(change)}</span></p><p class="text-xs text-gray-400">in the last day</p>`;
                    } else {
                        trendHtml = `<p class="text-sm text-red-400">Equity is Down <span class="font-bold">${formatCurrency(change)}</span></p><p class="text-xs text-gray-400">in the last day</p>`;
                    }
                }
                DOMElements.equityTrendIndicator.innerHTML = trendHtml;


                const labels = snapshots.map(s => new Date(s.date).toLocaleDateString());
                const data = snapshots.map(s => s.netEquity);

                if (performanceChart) {
                    performanceChart.destroy();
                }

                performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Net Equity',
                            data: data,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            tension: 0.1,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                             y: { ticks: { color: '#9ca3af' } },
                             x: { ticks: { color: '#9ca3af' } }
                        }
                    }
                });
            };


            // --- CORE LOGIC FUNCTIONS ---
            const addTransaction = (type, description, amount, meta = {}) => {
                 state.transactions.unshift({id: Date.now(), date: new Date().toISOString(), type, description, amount, ...meta});
                 if (state.transactions.length > 50) state.transactions.pop();
            };

            const deleteTransactionAndReverse = (txId) => {
                const txIndex = state.transactions.findIndex(tx => tx.id === txId);
                if (txIndex === -1) return;

                const txToDelete = state.transactions.splice(txIndex, 1)[0];
                const { type, amount, loanId, sourceLoanId, targetLoanId, ticker, assetName } = txToDelete;
                const loan = state.loans.find(l => l.id === loanId);

                switch (type) {
                    case 'purchase': state.ccBalance -= amount; break;
                    case 'payment': if (loan) loan.principal -= amount; state.ccBalance += amount; break;
                    case 'reward': state.rewardsBalance -= amount; state.totalGrailRewardsEarned -= amount; break;
                    case 'reward_btc': state.rewardsBitcoinBalance -= amount; break;
                    case 'repayment':
                        if (loan) {
                            loan.principal += amount; 
                            if (txToDelete.description.includes('with rewards')) state.rewardsBalance += amount;
                        }
                        break;
                    case 'interest': if (loan) loan.interestAccrued -= amount; break;
                    case 'loan_transfer':
                        const sourceLoan = state.loans.find(l => l.id === sourceLoanId);
                        const targetLoan = state.loans.find(l => l.id === targetLoanId);
                        if (sourceLoan && targetLoan) {
                            sourceLoan.principal -= amount;
                            targetLoan.principal += amount;
                        }
                        break;
                    case 'collateral_add':
                        if (loan && ticker) {
                            const collateral = loan.collaterals.find(c => c.ticker === ticker);
                            if (collateral) {
                                collateral.amount -= amount;
                                if (collateral.amount < 0.000001) loan.collaterals = loan.collaterals.filter(c => c.ticker !== ticker);
                            }
                        }
                        break;
                    case 'collateral_remove':
                         if (loan && ticker) {
                            const collateral = loan.collaterals.find(c => c.ticker === ticker);
                            if (collateral) collateral.amount += amount;
                            else loan.collaterals.push({ id: Date.now(), assetName, amount, ticker, price: 0 });
                        }
                        break;
                }
                updateUI();
            };

            const fetchCryptoPrice = async () => {
                const allCollaterals = state.loans.flatMap(l => l.collaterals);
                let tickers = ['bitcoin', ...new Set(allCollaterals.map(c => c.ticker))];
                const uniqueTickers = [...new Set(tickers)].join(',');
                if (!uniqueTickers) { updateUI(); return Promise.resolve(); }
                try {
                    const apiUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${uniqueTickers}&vs_currencies=usd`;
                    const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    if(data.bitcoin && data.bitcoin.usd) state.bitcoinPrice = data.bitcoin.usd;
                    state.loans.forEach(loan => {
                        loan.collaterals.forEach(c => {
                            if (data[c.ticker] && data[c.ticker].usd) c.price = data[c.ticker].usd;
                        });
                    });
                } catch (error) { 
                    console.error('Failed to fetch crypto price:', error); 
                } finally {
                    return Promise.resolve();
                }
            };

            const advanceDay = async () => {
                state.loans.forEach(loan => {
                     if (!loan || loan.principal <= 0) return;
                    const dailyRate = (loan.borrowAPR / 100) / 365;
                    const interest = loan.principal * dailyRate;
                    loan.interestAccrued += interest;
                    addTransaction('interest', `Interest on ${loan.name}`, interest, { loanId: loan.id });
                });

                await fetchCryptoPrice();

                const totalCollateral = state.loans.reduce((sum, loan) => sum + loan.collaterals.reduce((total, c) => total + (c.amount * c.price), 0), 0);
                const totalOwed = state.loans.reduce((sum, loan) => sum + loan.principal + loan.interestAccrued, 0);
                
                state.dailySnapshots.push({
                    date: new Date().toISOString(),
                    totalCollateral: totalCollateral,
                    totalOwed: totalOwed,
                    netEquity: totalCollateral - totalOwed,
                });

                if(state.dailySnapshots.length > 30) state.dailySnapshots.shift();

                updateUI();
            };

            // --- EVENT HANDLERS ---
            DOMElements.transactionLog.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-tx-btn')) {
                    const idToDelete = parseInt(e.target.dataset.id);
                    deleteTransactionAndReverse(idToDelete);
                }
            });

            DOMElements.advanceDayButton.addEventListener('click', advanceDay);

            DOMElements.addPurchaseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(DOMElements.purchaseAmountInput.value);
                if (isNaN(amount) || amount <= 0) return;
                if (state.ccBalance + amount > state.ccLimit) return alert('This purchase exceeds your credit limit.');
                state.ccBalance += amount;
                addTransaction('purchase', `Credit Card Purchase`, amount);
                if (state.rewardsBitcoinPercentage > 0 && state.bitcoinPrice > 0) {
                    const rewardInUSD = (amount * state.rewardsBitcoinPercentage) / 100;
                    const rewardInBTC = rewardInUSD / state.bitcoinPrice;
                    state.rewardsBitcoinBalance += rewardInBTC;
                    addTransaction('reward_btc', `Bitcoin Reward`, rewardInBTC);
                }
                DOMElements.purchaseAmountInput.value = '';
                updateUI();
            });
            
            DOMElements.payWithDeFiButton.addEventListener('click', () => {
                const loanId = parseInt(DOMElements.actionLoanSelect.value);
                const loan = state.loans.find(l => l.id === loanId);
                const amountToPay = state.ccBalance;
                if (amountToPay <= 0 || !loan) return;
                if ((loan.principal + loan.interestAccrued + amountToPay) > loan.positionLimit) return alert('This payment exceeds your DeFi loan position limit.');
                loan.principal += amountToPay;
                state.ccBalance = 0;
                addTransaction('payment', `Card payoff from ${loan.name}`, amountToPay, { loanId });
                updateUI();
            });

            DOMElements.claimRewardsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(DOMElements.rewardsAmountInput.value);
                if (isNaN(amount) || amount <= 0) return;
                state.rewardsBalance += amount;
                state.totalGrailRewardsEarned += amount;
                addTransaction('reward', 'Grail Rewards Claimed', amount);
                DOMElements.rewardsAmountInput.value = '';
                updateUI();
            });

            DOMElements.repayLoanForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const loanId = parseInt(DOMElements.repayLoanSelect.value);
                const loan = state.loans.find(l => l.id === loanId);
                const amount = parseFloat(DOMElements.repayAmountInput.value);
                if (!loan || isNaN(amount) || amount <= 0) return;
                const totalOwed = loan.principal + loan.interestAccrued;
                const amountToRepay = Math.min(amount, totalOwed);
                if (amount > totalOwed) alert(`Repayment amount exceeds total owed. Repaying ${formatCurrency(amountToRepay)}.`);
                if (amountToRepay <= 0) return;
                const interestPaid = Math.min(amountToRepay, loan.interestAccrued);
                loan.interestAccrued -= interestPaid;
                loan.principal -= (amountToRepay - interestPaid);
                addTransaction('repayment', `Repayment to ${loan.name}`, amountToRepay, { loanId });
                DOMElements.repayAmountInput.value = '';
                updateUI();
            });

            DOMElements.repayWithRewardsBtn.addEventListener('click', () => {
                const loanId = parseInt(DOMElements.repayLoanSelect.value);
                const loan = state.loans.find(l => l.id === loanId);
                if (!loan) return;
                const totalOwed = loan.principal + loan.interestAccrued;
                const amountToRepay = Math.min(state.rewardsBalance, totalOwed);
                if (amountToRepay <= 0) return;
                state.rewardsBalance -= amountToRepay;
                const interestPaid = Math.min(amountToRepay, loan.interestAccrued);
                loan.interestAccrued -= interestPaid;
                loan.principal -= (amountToRepay - interestPaid);
                addTransaction('repayment', `Repayment to ${loan.name} with rewards`, amountToRepay, { loanId });
                updateUI();
            });

            DOMElements.interLoanRepayForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const sourceLoanId = parseInt(DOMElements.repaySourceLoanSelect.value);
                const targetLoanId = parseInt(DOMElements.repayTargetLoanSelect.value);
                const amount = parseFloat(DOMElements.interLoanRepayAmountInput.value);
                
                if (sourceLoanId === targetLoanId) return alert("Source and target loans cannot be the same.");

                const sourceLoan = state.loans.find(l => l.id === sourceLoanId);
                const targetLoan = state.loans.find(l => l.id === targetLoanId);

                if (!sourceLoan || !targetLoan || isNaN(amount) || amount <= 0) return;

                const sourceTotalOwed = sourceLoan.principal + sourceLoan.interestAccrued;
                if ((sourceTotalOwed + amount) > sourceLoan.positionLimit) return alert(`Borrowing ${formatCurrency(amount)} exceeds ${sourceLoan.name} position limit.`);
                
                const targetTotalOwed = targetLoan.principal + targetLoan.interestAccrued;
                const amountToRepay = Math.min(amount, targetTotalOwed);
                
                sourceLoan.principal += amountToRepay;

                const interestPaid = Math.min(amountToRepay, targetLoan.interestAccrued);
                targetLoan.interestAccrued -= interestPaid;
                targetLoan.principal -= (amountToRepay - interestPaid);

                addTransaction('loan_transfer', `Transfer from ${sourceLoan.name} to ${targetLoan.name}`, amountToRepay, { sourceLoanId, targetLoanId });
                DOMElements.interLoanRepayAmountInput.value = '';
                updateUI();
            });

            DOMElements.addCollateralForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const loanId = parseInt(DOMElements.collateralLoanSelect.value);
                const loan = state.loans.find(l => l.id === loanId);
                if (!loan) return;

                const assetName = DOMElements.collateralNameInput.value.trim();
                const amount = parseFloat(DOMElements.collateralAmountInput.value);
                const ticker = DOMElements.collateralTickerInput.value.toLowerCase().trim();

                if (!assetName || !ticker || isNaN(amount) || amount <= 0) {
                    return alert('Please fill out all collateral fields correctly.');
                }
                const existingCollateral = loan.collaterals.find(c => c.ticker === ticker);

                if (existingCollateral) {
                    existingCollateral.amount += amount;
                    addTransaction('collateral_add', `Deposited ${amount} more ${assetName} to ${loan.name}`, amount, { loanId, ticker });
                } else {
                    const newCollateral = {
                        id: Date.now(),
                        assetName: assetName,
                        amount: amount,
                        ticker: ticker,
                        price: 0
                    };
                    loan.collaterals.push(newCollateral);
                    addTransaction('collateral_add', `Deposited ${assetName} to ${loan.name}`, amount, { loanId, ticker, assetName });
                }

                DOMElements.addCollateralForm.reset();
                fetchCryptoPrice().then(updateUI);
            });

            DOMElements.loanCardsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-collateral-btn')) {
                    const loanId = parseInt(e.target.dataset.loanId);
                    const collateralId = parseInt(e.target.dataset.collateralId);
                    const loan = state.loans.find(l => l.id === loanId);
                    if (!loan) return;
                    const collateralToRemove = loan.collaterals.find(c => c.id === collateralId);
                    if (collateralToRemove) {
                         addTransaction('collateral_remove', `Withdrew ${collateralToRemove.assetName} from ${loan.name}`, collateralToRemove.amount, { 
                            loanId, 
                            ticker: collateralToRemove.ticker,
                            assetName: collateralToRemove.assetName
                        });
                    }
                    loan.collaterals = loan.collaterals.filter(c => c.id !== collateralId);
                    fetchCryptoPrice().then(updateUI);
                }
            });
            
            // --- MODAL HANDLING ---
            const openModal = () => {
                document.getElementById('setting-cc-limit').value = state.ccLimit;
                document.getElementById('setting-btc-rewards').value = state.rewardsBitcoinPercentage;
                DOMElements.loanSettingsContainer.innerHTML = '';
                state.loans.forEach(loan => {
                    const loanSettingsEl = document.createElement('div');
                    loanSettingsEl.className = 'p-2 border border-gray-600 rounded-md';
                    loanSettingsEl.innerHTML = `
                        <p class="font-semibold text-white">${loan.name}</p>
                        <label class="text-xs">Position Limit ($)</label>
                        <input type="number" data-loan-id="${loan.id}" data-prop="positionLimit" value="${loan.positionLimit}" class="mt-1 w-full bg-gray-700 border-gray-500 rounded-md shadow-sm text-sm">
                        <label class="text-xs">Borrow APR (%)</label>
                        <input type="number" data-loan-id="${loan.id}" data-prop="borrowAPR" value="${loan.borrowAPR}" class="mt-1 w-full bg-gray-700 border-gray-500 rounded-md shadow-sm text-sm">
                        <label class="text-xs">Liq. Threshold (%)</label>
                        <input type="number" data-loan-id="${loan.id}" data-prop="liquidationThreshold" value="${loan.liquidationThreshold}" class="mt-1 w-full bg-gray-700 border-gray-500 rounded-md shadow-sm text-sm">
                    `;
                    DOMElements.loanSettingsContainer.appendChild(loanSettingsEl);
                });
                DOMElements.settingsModal.classList.remove('hidden');
            };
            
            const closeModal = () => DOMElements.settingsModal.classList.add('hidden');
            
            DOMElements.settingsButton.addEventListener('click', openModal);
            DOMElements.closeModalButton.addEventListener('click', closeModal);
            DOMElements.cancelSettingsButton.addEventListener('click', closeModal);
            
            DOMElements.settingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                state.ccLimit = parseFloat(document.getElementById('setting-cc-limit').value);
                state.rewardsBitcoinPercentage = parseFloat(document.getElementById('setting-btc-rewards').value);
                DOMElements.loanSettingsContainer.querySelectorAll('input[data-loan-id]').forEach(input => {
                    const loanId = parseInt(input.dataset.loanId);
                    const prop = input.dataset.prop;
                    const loan = state.loans.find(l => l.id === loanId);
                    if (loan) loan[prop] = parseFloat(input.value);
                });
                closeModal();
                updateUI();
            });

            // --- INITIALIZATION ---
            loadState();
            fetchCryptoPrice().then(updateUI);
            setInterval(() => fetchCryptoPrice().then(updateUI), 60000);
        });
    </script>
</body>
</html>

