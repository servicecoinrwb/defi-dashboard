<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi & Credit Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #1f2937; /* dark:bg-gray-800 */
            border: 1px solid #374151; /* dark:border-gray-700 */
        }
        .progress-bar-bg {
             background-color: #374151; /* dark:bg-gray-700 */
        }
        /* Custom scrollbar for transaction log */
        #transaction-log::-webkit-scrollbar {
            width: 8px;
        }
        #transaction-log::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        #transaction-log::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        #transaction-log::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .remove-collateral-btn {
            font-size: 1.5rem;
            line-height: 1;
            padding: 0 0.5rem;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">DeFi & Credit Dashboard</h1>
                <p class="text-gray-400 mt-1">Track your credit utilization and DeFi loan health in real-time.</p>
            </div>
            <button id="settings-button" class="p-2 rounded-lg hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0-2.4l.15-.08a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </header>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <!-- Card: Credit Card Status -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-blue-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">Credit Card</h2>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span>Balance:</span> <span id="cc-balance" class="font-medium text-white">$0.00</span></div>
                    <div class="flex justify-between"><span>Available:</span> <span id="cc-available" class="font-medium text-green-400">$5,000.00</span></div>
                    <div class="flex justify-between"><span>Limit:</span> <span id="cc-limit" class="font-medium text-gray-400">$5,000.00</span></div>
                </div>
                <div class="mt-4">
                    <div class="progress-bar-bg w-full rounded-full h-2.5">
                        <div id="cc-progress" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Card: DeFi Loan Status -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-purple-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">DeFi Loan</h2>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span>Total Collateral Value:</span> <span id="collateral-value" class="font-medium text-white">$0.00</span></div>
                    <div class="flex justify-between"><span>Loan Balance:</span> <span id="defi-balance" class="font-medium text-white">$0.00</span></div>
                    <div class="flex justify-between"><span>Available to Borrow:</span> <span id="defi-available" class="font-medium text-green-400">$5,000.00</span></div>
                    <div class="flex justify-between"><span>Borrow APR:</span> <span id="borrow-apr-display" class="font-medium text-white">0.00%</span></div>
                </div>
                <div class="mt-4">
                    <p class="text-sm font-medium text-white mb-1">Loan-to-Value (LTV): <span id="ltv-percentage">0.00%</span></p>
                    <div class="progress-bar-bg w-full rounded-full h-2.5 relative">
                        <div id="ltv-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                        <div id="liquidation-marker" class="absolute top-0 h-full w-0.5 bg-red-500" style="left: 80%;" title="Liquidation Threshold"></div>
                    </div>
                     <p class="text-xs text-gray-400 mt-1">Liquidation at <span id="liquidation-threshold-text">80</span>%</p>
                </div>
            </div>

            <!-- Card: Collateral Details -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-orange-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">Collateral Details</h2>
                </div>
                <div id="collateral-list" class="space-y-2 h-40 overflow-y-auto pr-2">
                    <!-- Collateral items will be dynamically inserted here -->
                </div>
            </div>

            <!-- Card: Grail Rewards -->
            <div class="card rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-4">
                     <div class="p-2 bg-teal-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-400"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                     </div>
                    <h2 class="text-xl font-semibold text-white">Grail Rewards</h2>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span>USDC.e Balance:</span> <span id="rewards-balance" class="font-medium text-white">$0.00</span></div>
                </div>
                <form id="claim-rewards-form" class="mt-4 pt-4 border-t border-gray-700 space-y-4">
                    <div>
                        <label for="rewards-amount" class="block text-sm font-medium text-gray-300">Claim New Rewards</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-600 bg-gray-700 text-gray-400 sm:text-sm">$</span>
                            <input type="number" id="rewards-amount" class="flex-1 block w-full rounded-none rounded-r-md bg-gray-800 border-gray-600 focus:ring-teal-500 focus:border-teal-500 sm:text-sm" placeholder="50.25" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Claim Rewards</button>
                </form>
                <div class="mt-4">
                    <button id="repay-with-rewards" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">Repay Loan with Rewards</button>
                </div>
            </div>

            <!-- Card: Actions -->
            <div class="card rounded-xl shadow-lg p-6 lg:col-span-2">
                 <div class="flex items-center mb-4">
                     <div class="p-2 bg-green-500/20 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/><path d="M12 8v8"/><path d="m8.5 12.5 7-5"/><path d="m8.5 16.5 7-5"/></svg>
                     </div>
                    <h2 class="text-xl font-semibold text-white">Financial Actions</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column: CC & Loan Repay -->
                    <div>
                        <form id="add-purchase-form" class="space-y-4">
                            <div>
                                <label for="purchase-amount" class="block text-sm font-medium text-gray-300">New Card Purchase</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-600 bg-gray-700 text-gray-400 sm:text-sm">$</span>
                                    <input type="number" id="purchase-amount" class="flex-1 block w-full rounded-none rounded-r-md bg-gray-800 border-gray-600 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="150.75" step="0.01" required>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Add Purchase</button>
                        </form>
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <button id="pay-with-defi" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">Pay Card with DeFi Loan</button>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <form id="repay-loan-form" class="space-y-4">
                                <div>
                                    <label for="repay-amount" class="block text-sm font-medium text-gray-300">Repay Loan from Source</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-600 bg-gray-700 text-gray-400 sm:text-sm">$</span>
                                        <input type="number" id="repay-amount" class="flex-1 block w-full rounded-none rounded-r-md bg-gray-800 border-gray-600 focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="1000.00" step="0.01" required>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Repay Loan</button>
                            </form>
                        </div>
                    </div>
                    <!-- Right Column: Collateral Management -->
                    <div>
                        <form id="add-collateral-form" class="space-y-4">
                            <h3 class="text-md font-semibold text-white -mb-2">Manage Collateral</h3>
                            <div>
                                <label for="collateral-name-input" class="block text-sm font-medium text-gray-300">Asset Name</label>
                                <input type="text" id="collateral-name-input" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" placeholder="e.g., GRAIL" required>
                            </div>
                             <div>
                                <label for="collateral-amount-input" class="block text-sm font-medium text-gray-300">Amount</label>
                                <input type="number" id="collateral-amount-input" step="any" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" placeholder="e.g., 130.009" required>
                            </div>
                            <div>
                                <label for="collateral-ticker-input" class="block text-sm font-medium text-gray-300">CoinGecko ID</label>
                                <input type="text" id="collateral-ticker-input" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" placeholder="e.g., camelot-token" required>
                            </div>
                            <button type="submit" class="w-full bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">Add Collateral</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Card: Transaction Log -->
            <div class="card rounded-xl shadow-lg p-6 lg:col-span-3">
                <h2 class="text-xl font-semibold text-white mb-4">Transaction Log</h2>
                <div id="transaction-log" class="h-64 overflow-y-auto space-y-3 pr-2">
                     <p class="text-gray-500 text-center pt-8">No transactions yet.</p>
                </div>
            </div>

        </div>

    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="card w-full max-w-md p-6 rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">General Settings</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="settings-form" class="space-y-4">
                <div>
                    <label for="setting-cc-limit" class="block text-sm font-medium text-gray-300">Credit Card Limit ($)</label>
                    <input type="number" id="setting-cc-limit" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" step="any" required>
                </div>
                 <div>
                    <label for="setting-defi-limit" class="block text-sm font-medium text-gray-300">DeFi Loan Position Limit ($)</label>
                    <input type="number" id="setting-defi-limit" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" step="any" required>
                </div>
                 <div>
                    <label for="setting-borrow-apr" class="block text-sm font-medium text-gray-300">Borrow APR (%)</label>
                    <input type="number" id="setting-borrow-apr" step="any" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="setting-liquidation-threshold" class="block text-sm font-medium text-gray-300">LTV Liquidation Threshold (%)</label>
                    <input type="number" id="setting-liquidation-threshold" class="mt-1 w-full bg-gray-800 border-gray-600 rounded-md shadow-sm" required>
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-settings" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors text-white font-semibold">Save</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT REFERENCES ---
            const DOMElements = {
                ccBalance: document.getElementById('cc-balance'),
                ccAvailable: document.getElementById('cc-available'),
                ccLimit: document.getElementById('cc-limit'),
                ccProgress: document.getElementById('cc-progress'),
                defiBalance: document.getElementById('defi-balance'),
                defiAvailable: document.getElementById('defi-available'),
                collateralValue: document.getElementById('collateral-value'),
                ltvPercentage: document.getElementById('ltv-percentage'),
                ltvBar: document.getElementById('ltv-bar'),
                liquidationMarker: document.getElementById('liquidation-marker'),
                liquidationThresholdText: document.getElementById('liquidation-threshold-text'),
                addPurchaseForm: document.getElementById('add-purchase-form'),
                purchaseAmountInput: document.getElementById('purchase-amount'),
                payWithDeFiButton: document.getElementById('pay-with-defi'),
                transactionLog: document.getElementById('transaction-log'),
                settingsButton: document.getElementById('settings-button'),
                settingsModal: document.getElementById('settings-modal'),
                closeModalButton: document.getElementById('close-modal-button'),
                cancelSettingsButton: document.getElementById('cancel-settings'),
                settingsForm: document.getElementById('settings-form'),
                rewardsBalance: document.getElementById('rewards-balance'),
                claimRewardsForm: document.getElementById('claim-rewards-form'),
                rewardsAmountInput: document.getElementById('rewards-amount'),
                repayWithRewardsButton: document.getElementById('repay-with-rewards'),
                collateralList: document.getElementById('collateral-list'),
                borrowAPRDisplay: document.getElementById('borrow-apr-display'),
                repayLoanForm: document.getElementById('repay-loan-form'),
                repayAmountInput: document.getElementById('repay-amount'),
                addCollateralForm: document.getElementById('add-collateral-form'),
                collateralNameInput: document.getElementById('collateral-name-input'),
                collateralAmountInput: document.getElementById('collateral-amount-input'),
                collateralTickerInput: document.getElementById('collateral-ticker-input'),
            };

            // --- APPLICATION STATE (PRE-FILLED FROM IMAGE) ---
            let state = {
                ccLimit: 5000,
                ccBalance: 0,
                defiLoanPositionLimit: 18290.82,
                defiLoanBalance: 14402.16,
                collaterals: [{
                    id: Date.now(),
                    assetName: 'GRAIL',
                    amount: 130.009,
                    ticker: 'camelot-token',
                    price: 0
                }],
                borrowAPR: 15.7,
                liquidationThreshold: 80,
                transactions: [],
                rewardsBalance: 0,
            };

            // --- UTILITY FUNCTIONS ---
            const formatCurrency = (amount) => `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const formatNumber = (num) => num.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });

            const loadState = () => {
                const savedState = localStorage.getItem('defiCreditDashboardState');
                if (savedState) {
                    let loaded = JSON.parse(savedState);
                    // Migration from old structure to new
                    if (loaded.collateralAmount && !loaded.collaterals) {
                        loaded.collaterals = [{
                            id: Date.now(),
                            assetName: loaded.collateralAsset || 'GRAIL',
                            amount: loaded.collateralAmount,
                            ticker: loaded.collateralTicker,
                            price: 0
                        }];
                        delete loaded.collateralAmount;
                        delete loaded.collateralAsset;
                        delete loaded.collateralTicker;
                        delete loaded.liquidationPrice;
                    }
                    state = { ...state, ...loaded };
                }
            };
            
            const saveState = () => {
                localStorage.setItem('defiCreditDashboardState', JSON.stringify(state));
            };

            // --- UI UPDATE FUNCTION ---
            const updateUI = () => {
                // Derived values
                const ccAvailable = state.ccLimit - state.ccBalance;
                const ccUsagePercent = (state.ccLimit > 0 ? state.ccBalance / state.ccLimit : 0) * 100;
                
                const totalCollateralValue = state.collaterals.reduce((total, c) => total + (c.amount * c.price), 0);
                
                const defiAvailableToBorrow = Math.max(0, state.defiLoanPositionLimit - state.defiLoanBalance);
                const ltv = totalCollateralValue > 0 ? (state.defiLoanBalance / totalCollateralValue) * 100 : 0;

                // Update Credit Card panel
                DOMElements.ccLimit.textContent = formatCurrency(state.ccLimit);
                DOMElements.ccBalance.textContent = formatCurrency(state.ccBalance);
                DOMElements.ccAvailable.textContent = formatCurrency(ccAvailable);
                DOMElements.ccProgress.style.width = `${ccUsagePercent}%`;

                // Update DeFi Loan panel
                DOMElements.collateralValue.textContent = formatCurrency(totalCollateralValue);
                DOMElements.defiBalance.textContent = formatCurrency(state.defiLoanBalance);
                DOMElements.defiAvailable.textContent = formatCurrency(defiAvailableToBorrow);
                DOMElements.borrowAPRDisplay.textContent = `${state.borrowAPR}%`;
                
                // Update Collateral Details panel
                const collateralListEl = DOMElements.collateralList;
                collateralListEl.innerHTML = '';
                if (state.collaterals.length > 0) {
                    state.collaterals.forEach(c => {
                        const itemValue = c.amount * c.price;
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex justify-between items-center text-sm p-2 rounded-md bg-gray-700/50';
                        itemEl.innerHTML = `
                            <div>
                                <p class="font-bold text-white">${c.assetName} (${formatNumber(c.amount)})</p>
                                <p class="text-xs text-gray-400">Value: ${formatCurrency(itemValue)} (@ ${formatCurrency(c.price)})</p>
                            </div>
                            <button data-id="${c.id}" class="remove-collateral-btn text-red-400 hover:text-red-300 transition-colors" title="Remove Collateral">&times;</button>
                        `;
                        collateralListEl.appendChild(itemEl);
                    });
                } else {
                    collateralListEl.innerHTML = `<p class="text-gray-500 text-center text-sm pt-12">No collateral deposited.</p>`;
                }

                // Update Rewards panel
                DOMElements.rewardsBalance.textContent = formatCurrency(state.rewardsBalance);

                // Update LTV display
                DOMElements.ltvPercentage.textContent = `${ltv.toFixed(2)}%`;
                DOMElements.ltvBar.style.width = `${ltv}%`;
                
                const dangerZone = state.liquidationThreshold - 15;
                const warningZone = state.liquidationThreshold - 30;
                if (ltv >= dangerZone) {
                    DOMElements.ltvBar.className = 'bg-red-500 h-2.5 rounded-full transition-all';
                } else if (ltv >= warningZone) {
                    DOMElements.ltvBar.className = 'bg-yellow-500 h-2.5 rounded-full transition-all';
                } else {
                    DOMElements.ltvBar.className = 'bg-green-500 h-2.5 rounded-full transition-all';
                }
                
                DOMElements.liquidationThresholdText.textContent = state.liquidationThreshold;
                DOMElements.liquidationMarker.style.left = `${state.liquidationThreshold}%`;

                DOMElements.payWithDeFiButton.disabled = state.ccBalance <= 0;
                DOMElements.repayWithRewardsButton.disabled = state.rewardsBalance <= 0 || state.defiLoanBalance <= 0;

                renderTransactions();
                saveState();
            };

            const renderTransactions = () => {
                const getTxBgColor = (type) => {
                    switch(type) {
                        case 'purchase': return 'bg-gray-800';
                        case 'payment': return 'bg-purple-900/50';
                        case 'reward': return 'bg-teal-900/50';
                        case 'repayment': return 'bg-green-900/50';
                        case 'collateral_add': return 'bg-orange-900/50';
                        case 'collateral_remove': return 'bg-red-900/50';
                        default: return 'bg-gray-800';
                    }
                }
                const getTxAmountColor = (type, amount) => {
                    if (type === 'purchase' || type === 'collateral_remove') return 'text-red-400';
                    return 'text-green-400';
                }

                if(state.transactions.length === 0) {
                     DOMElements.transactionLog.innerHTML = `<p class="text-gray-500 text-center pt-8">No transactions yet.</p>`;
                     return;
                }
                
                DOMElements.transactionLog.innerHTML = state.transactions
                    .map(tx => `
                        <div class="flex justify-between items-center text-sm p-2 rounded-md ${getTxBgColor(tx.type)}">
                           <div>
                                <p class="font-medium text-white">${tx.description}</p>
                                <p class="text-xs text-gray-400">${new Date(tx.date).toLocaleString()}</p>
                           </div>
                           <span class="font-bold ${getTxAmountColor(tx.type, tx.amount)}">
                                ${tx.amount > 0 && !['purchase', 'collateral_remove'].includes(tx.type) ? '+' : ''}${formatCurrency(tx.amount)}
                           </span>
                        </div>
                    `).join('');
            };
            
            const addTransaction = (type, description, amount) => {
                 state.transactions.unshift({
                     id: Date.now(),
                     date: new Date().toISOString(),
                     type,
                     description,
                     amount
                 });
                 if (state.transactions.length > 50) state.transactions.pop();
            };

            const fetchCryptoPrice = async () => {
                if (state.collaterals.length === 0) {
                    updateUI();
                    return;
                }
                const tickers = [...new Set(state.collaterals.map(c => c.ticker))].join(',');
                if (!tickers) {
                    updateUI();
                    return;
                }
                try {
                    const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${tickers}&vs_currencies=usd`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    state.collaterals.forEach(c => {
                        if (data[c.ticker] && data[c.ticker].usd) {
                            c.price = data[c.ticker].usd;
                        }
                    });
                } catch (error) {
                    console.error('Failed to fetch crypto price:', error);
                } finally {
                    updateUI();
                }
            };

            // --- EVENT HANDLERS ---
            DOMElements.addPurchaseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(DOMElements.purchaseAmountInput.value);
                if (isNaN(amount) || amount <= 0) return;
                if (state.ccBalance + amount > state.ccLimit) {
                    alert('This purchase exceeds your credit limit.');
                    return;
                }
                state.ccBalance += amount;
                addTransaction('purchase', `Credit Card Purchase`, amount);
                DOMElements.purchaseAmountInput.value = '';
                updateUI();
            });

            DOMElements.payWithDeFiButton.addEventListener('click', () => {
                const amountToPay = state.ccBalance;
                if (amountToPay <= 0) return;
                if (state.defiLoanBalance + amountToPay > state.defiLoanPositionLimit) {
                    alert('This payment exceeds your DeFi loan position limit.');
                    return;
                }
                state.defiLoanBalance += amountToPay;
                state.ccBalance = 0;
                addTransaction('payment', `Payoff from DeFi`, amountToPay);
                updateUI();
            });

            DOMElements.claimRewardsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(DOMElements.rewardsAmountInput.value);
                if (isNaN(amount) || amount <= 0) return;
                state.rewardsBalance += amount;
                addTransaction('reward', 'Grail Rewards Claimed', amount);
                DOMElements.rewardsAmountInput.value = '';
                updateUI();
            });

            DOMElements.repayWithRewardsButton.addEventListener('click', () => {
                const amountToRepay = Math.min(state.rewardsBalance, state.defiLoanBalance);
                if(amountToRepay <= 0) return;
                state.rewardsBalance -= amountToRepay;
                state.defiLoanBalance -= amountToRepay;
                addTransaction('repayment', 'Loan Repayment with Rewards', amountToRepay);
                updateUI();
            });

            DOMElements.repayLoanForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(DOMElements.repayAmountInput.value);
                if (isNaN(amount) || amount <= 0) return;
                const amountToRepay = Math.min(amount, state.defiLoanBalance);
                if (amount > state.defiLoanBalance) {
                    alert(`Repayment amount exceeds loan balance. Repaying ${formatCurrency(amountToRepay)}.`);
                }
                if (amountToRepay <= 0) return;
                state.defiLoanBalance -= amountToRepay;
                addTransaction('repayment', 'Loan Repayment from Deposit', amountToRepay);
                DOMElements.repayAmountInput.value = '';
                updateUI();
            });

            DOMElements.addCollateralForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newCollateral = {
                    id: Date.now(),
                    assetName: DOMElements.collateralNameInput.value.trim(),
                    amount: parseFloat(DOMElements.collateralAmountInput.value),
                    ticker: DOMElements.collateralTickerInput.value.toLowerCase().trim(),
                    price: 0
                };
                if (!newCollateral.assetName || !newCollateral.ticker || isNaN(newCollateral.amount) || newCollateral.amount <= 0) {
                    alert('Please fill out all collateral fields correctly.');
                    return;
                }
                state.collaterals.push(newCollateral);
                addTransaction('collateral_add', `Deposited ${newCollateral.assetName}`, newCollateral.amount);
                DOMElements.addCollateralForm.reset();
                fetchCryptoPrice();
            });

            DOMElements.collateralList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-collateral-btn')) {
                    const idToRemove = parseInt(e.target.dataset.id);
                    const collateralToRemove = state.collaterals.find(c => c.id === idToRemove);
                    if (collateralToRemove) {
                        addTransaction('collateral_remove', `Withdrew ${collateralToRemove.assetName}`, collateralToRemove.amount);
                    }
                    state.collaterals = state.collaterals.filter(c => c.id !== idToRemove);
                    updateUI();
                }
            });
            
            // --- MODAL HANDLING ---
            const openModal = () => {
                document.getElementById('setting-cc-limit').value = state.ccLimit;
                document.getElementById('setting-defi-limit').value = state.defiLoanPositionLimit;
                document.getElementById('setting-borrow-apr').value = state.borrowAPR;
                document.getElementById('setting-liquidation-threshold').value = state.liquidationThreshold;
                DOMElements.settingsModal.classList.remove('hidden');
            };
            
            const closeModal = () => DOMElements.settingsModal.classList.add('hidden');
            
            DOMElements.settingsButton.addEventListener('click', openModal);
            DOMElements.closeModalButton.addEventListener('click', closeModal);
            DOMElements.cancelSettingsButton.addEventListener('click', closeModal);
            
            DOMElements.settingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                state.ccLimit = parseFloat(document.getElementById('setting-cc-limit').value);
                state.defiLoanPositionLimit = parseFloat(document.getElementById('setting-defi-limit').value);
                state.borrowAPR = parseFloat(document.getElementById('setting-borrow-apr').value);
                state.liquidationThreshold = parseFloat(document.getElementById('setting-liquidation-threshold').value);
                closeModal();
                updateUI();
            });

            // --- INITIALIZATION ---
            loadState();
            fetchCryptoPrice();
            setInterval(fetchCryptoPrice, 60000);
        });
    </script>
</body>
</html>

